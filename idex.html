<script>
  // URL do seu backend (Render)
  const API_URL = "https://backend-peticoes.onrender.com/api/generate-petition";

  // Bloqueio explÃ­cito se abrir como arquivo local (file://)
  if (location.protocol === "file:") {
    alert("VocÃª abriu o arquivo diretamente (file://). Para funcionar, abra por http://localhost ou hospede o arquivo.\n\nSugestÃ£o rÃ¡pida:\n1) No PowerShell, vÃ¡ atÃ© a pasta do index.html\n2) Rode:  npx http-server -p 3000\n3) Acesse: http://localhost:3000");
  }

  document.addEventListener('DOMContentLoaded', function () {
    console.log("ðŸŸ¢ Front-end carregado.");
    console.log("ðŸ”„ Testando conexÃ£o com o backend...");

    // TESTE DE CONEXÃƒO COM O BACKEND
    fetch(API_URL, { method: 'OPTIONS', mode: 'cors' })
      .then(() => console.log("âœ… Backend respondeu (acordado)."))
      .catch(err => console.error("âŒ Backend nÃ£o respondeu:", err));

    // ----- TODA A LÃ“GICA EXISTENTE AQUI (NÃƒO ALTEREI NADA) -----
    const header = document.getElementById('main-header');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 50) header.classList.add('scrolled'); else header.classList.remove('scrolled');
    });

    const hamburger = document.querySelector('.hamburger');
    const navMenu = document.querySelector('.nav-menu');
    hamburger.addEventListener('click', () => { hamburger.classList.toggle('active'); navMenu.classList.toggle('active'); });
    document.querySelectorAll('a[href^="#"]').forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        const id = a.getAttribute('href').substring(1);
        const el = document.getElementById(id);
        if (el) el.scrollIntoView({ behavior:'smooth' });
        if (navMenu.classList.contains('active')) { hamburger.classList.remove('active'); navMenu.classList.remove('active'); }
      });
    });

    document.querySelectorAll('.faq-item').forEach(item => {
      item.querySelector('.faq-question').addEventListener('click', () => {
        item.classList.toggle('active');
        const ans = item.querySelector('.faq-answer');
        ans.style.maxHeight = item.classList.contains('active') ? ans.scrollHeight + "px" : null;
      });
    });

    const form = document.getElementById('petition-form');
    const resultScreen = document.getElementById('result-screen');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const progressBarFill = document.querySelector('.progress-bar-fill');
    const progressText = document.querySelector('.progress-text');
    const allSteps = Array.from(document.querySelectorAll('.quiz-step'));

    const stepBlocks = {
      corte_energia: ['corte-data','corte-aviso','corte-divida','corte-religacao','corte-prejuizo-pergunta'],
      danos_eletricos: ['oscilacao-data','oscilacao-equipamentos','oscilacao-comunicacao'],
      toi: ['toi-numero','toi-data','toi-presente','toi-cobranca'],
      recusa_ligacao: ['recusa-data-solicitacao','recusa-motivo','recusa-protocolo','recusa-moradores'],
      cobranca_indevida: ['cobranca-tipo','cobranca-reclamacao','cobranca-negativacao'],
      outro: []
    };

    let quizFlow = [];
    let currentStepIndex = 0;

    function startQuiz() {
      quizFlow = ['problem-type','author-info','author-cpf','author-address','author-contact','company-info','provas-gerais','valores-pedidos','info-finais'];
      currentStepIndex = 0;
      showStep(currentStepIndex);
    }

    function showStep(i) {
      allSteps.forEach(s => s.classList.remove('active'));
      const id = quizFlow[i];
      const step = allSteps.find(s => s.dataset.stepId === id);
      if (step) {
        step.classList.add('active');
        const first = step.querySelector('input, select, textarea');
        if (first) first.focus();
      }
      updateProgress();
      updateNav();
    }

    function updateProgress() {
      const pct = Math.max(0, (currentStepIndex) / (quizFlow.length - 1)) * 100;
      progressBarFill.style.width = `${pct}%`;
      progressText.textContent = `Pergunta ${currentStepIndex + 1} de ${quizFlow.length}`;
    }

    function updateNav() {
      prevBtn.style.visibility = currentStepIndex === 0 ? 'hidden' : 'visible';
      nextBtn.textContent = currentStepIndex === quizFlow.length - 1 ? 'Gerar PetiÃ§Ã£o' : 'PrÃ³ximo';
    }

    function navigate(dir) {
      if (dir === 1) {
        if (!validateCurrentStep()) return;
        updateQuizFlow();
        if (currentStepIndex === quizFlow.length - 1) submitForm();
        else { currentStepIndex++; showStep(currentStepIndex); }
      } else {
        if (currentStepIndex > 0) { currentStepIndex--; showStep(currentStepIndex); }
      }
    }

    function validateCurrentStep() {
      let ok = true;
      const id = quizFlow[currentStepIndex];
      const step = allSteps.find(s => s.dataset.stepId === id);
      step.querySelectorAll('[required]').forEach(input => {
        const group = input.closest('.form-group');
        let valid = true;
        if (input.type === 'radio' || input.type === 'checkbox') {
          const checked = step.querySelector(`input[name="${input.name}"]:checked`);
          if (!checked) valid = false;
        } else if (!input.value.trim()) valid = false;
        if (!valid) { ok = false; if (group) group.classList.add('invalid'); }
        else if (group) group.classList.remove('invalid');
      });
      return ok;
    }

    function updateQuizFlow() {
      const data = Object.fromEntries(new FormData(form).entries());
      const allDyn = Object.values(stepBlocks).flat();
      quizFlow = quizFlow.filter(s => !allDyn.includes(s));
      const type = data['problem-type'];
      if (type && stepBlocks[type]) {
        const idx = quizFlow.indexOf('company-info');
        if (idx > -1) quizFlow.splice(idx + 1, 0, ...stepBlocks[type]);
      }
    }

    // âœ… AQUI ESTÃ O NOVO SUBMIT COM ERRO DETALHADO
    async function submitForm() {
      console.log("ðŸ”„ Enviando dados ao backend...");

      nextBtn.textContent = 'Gerando...';
      nextBtn.disabled = true;

      const fd = new FormData(form);
      const data = {};
      fd.forEach((v, k) => {
        if (data[k]) {
          if (!Array.isArray(data[k])) data[k] = [data[k]];
          data[k].push(v);
        } else data[k] = v;
      });

      try {
        const resp = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
          mode: 'cors'
        });

        if (!resp.ok) {
          let errData;
          try { errData = await resp.json(); } catch { errData = { error: "Erro desconhecido" }; }

          console.error("âŒ Erro detalhado da API:", errData);

          alert("Erro ao gerar a petiÃ§Ã£o. Abra o console (F12) para ver o erro detalhado.");

          return;
        }

        const result = await resp.json();
        const petitionText = result.text || 'A IA nÃ£o retornou texto.';

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation:'p', unit:'mm', format:'a4' });

        const margin = 20;
        const maxW = doc.internal.pageSize.width - margin * 2;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(12);

        const lines = doc.splitTextToSize(petitionText, maxW);
        let y = margin;
        for (const line of lines) {
          if (y > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
          doc.text(line, margin, y);
          y += 7;
        }
        doc.save('peticao.pdf');

        form.style.display = 'none';
        resultScreen.style.display = 'block';

      } catch (e) {
        console.error("âŒ Erro de conexÃ£o com o backend:", e);
        alert("Erro de conexÃ£o com o servidor. Veja o console (F12).");
      }

      nextBtn.textContent = 'Gerar PetiÃ§Ã£o';
      nextBtn.disabled = false;
    }

    form.querySelectorAll('input, select, textarea').forEach(input => {
      const evt = (input.tagName === 'SELECT' || input.type === 'radio' || input.type === 'checkbox') ? 'change' : 'input';
      input.addEventListener(evt, e => e.target.closest('.form-group')?.classList.remove('invalid'));
    });

    nextBtn.addEventListener('click', () => navigate(1));
    prevBtn.addEventListener('click', () => navigate(-1));

    document.getElementById('restart-quiz-btn').addEventListener('click', () => {
      resultScreen.style.display = 'none';
      form.style.display = 'block';
      form.reset();
      startQuiz();
    });

    startQuiz();
  });
</script>
